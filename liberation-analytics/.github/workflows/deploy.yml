name: üöÄ Liberation Analytics Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options: 
          - staging
          - production
        default: staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: thegreenfieldoverride/liberation-analytics

jobs:
  test:
    name: üß™ Test Liberation Analytics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v ./...

      - name: Build binary
        run: CGO_ENABLED=1 go build -o liberation-analytics ./main.go

      - name: Test binary startup
        run: |
          ./liberation-analytics &
          ANALYTICS_PID=$!
          sleep 5
          
          # Test health endpoint
          if curl -f http://localhost:8080/api/health; then
            echo "‚úÖ Analytics service started successfully"
          else
            echo "‚ùå Analytics service failed to start"
            exit 1
          fi
          
          kill $ANALYTICS_PID

  deploy:
    name: üöÄ Deploy Liberation Analytics
    needs: [test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Set deployment variables
        run: |
          if [ "${{ github.event.inputs.environment || 'staging' }}" = "production" ]; then
            echo "DEPLOY_PORT=8080" >> $GITHUB_ENV
            echo "CONTAINER_NAME=liberation-analytics-production" >> $GITHUB_ENV
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "IMAGE_TAG=main" >> $GITHUB_ENV
          else
            echo "DEPLOY_PORT=8081" >> $GITHUB_ENV
            echo "CONTAINER_NAME=liberation-analytics-staging" >> $GITHUB_ENV
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "IMAGE_TAG=main" >> $GITHUB_ENV
          fi

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Liberation Analytics
        env:
          HOST: ${{ secrets.HETZNER_HOST }}
          USER: ${{ secrets.HETZNER_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
          DEPLOY_PORT: ${{ env.DEPLOY_PORT }}
        run: |
          ssh $USER@$HOST << 'EOF'
            set -e
            
            echo "üöÄ Deploying Liberation Analytics to ${{ env.ENVIRONMENT }}..."
            echo "üì¶ Container: ${{ env.CONTAINER_NAME }}"
            echo "üîó Port: ${{ env.DEPLOY_PORT }}"
            
            # Create analytics deployment directory
            sudo mkdir -p /opt/liberation-analytics
            sudo chown deploy-bot:deploy-bot /opt/liberation-analytics
            cd /opt/liberation-analytics
            
            # Update/clone analytics repository
            if [ -d ".git" ]; then
              echo "üì• Updating analytics code..."
              git fetch origin
              git checkout main
              git pull origin main
            else
              echo "üì• Cloning analytics repository..."
              rm -rf * .* 2>/dev/null || true
              git clone https://github.com/thegreenfieldoverride/liberation-analytics.git .
            fi
            
            # Update environment configuration
            echo "‚öôÔ∏è Configuring environment..."
            if [ ! -f .env ]; then
              cp .env.example .env
            fi
            
            # Update .env with production values
            sed -i "s/^POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}/" .env
            sed -i "s/^ENVIRONMENT=.*/ENVIRONMENT=${{ env.ENVIRONMENT }}/" .env
            
            # Ensure proper volume permissions
            echo "üìÅ Setting up data volumes..."
            sudo mkdir -p /mnt/analytics-volume/data
            sudo mkdir -p /mnt/postgres-volume/data
            sudo chown -R 1000:1000 /mnt/analytics-volume/data
            sudo chown -R 999:999 /mnt/postgres-volume/data
            
            # Stop existing analytics containers
            echo "üîÑ Stopping existing analytics containers..."
            docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            docker stop liberation-analytics 2>/dev/null || true
            docker rm liberation-analytics 2>/dev/null || true
            
            # Clean up any containers using the port
            EXISTING_CONTAINER=$(docker ps --filter "publish=${{ env.DEPLOY_PORT }}" --format "{{.Names}}" | head -1)
            if [ -n "$EXISTING_CONTAINER" ]; then
              echo "üîÑ Removing container using port ${{ env.DEPLOY_PORT }}: $EXISTING_CONTAINER"
              docker rm -f "$EXISTING_CONTAINER" || true
            fi
            
            # Build new analytics image
            echo "üèóÔ∏è Building analytics image..."
            docker build -t liberation-analytics:${{ env.ENVIRONMENT }}-latest .
            
            # Start new analytics container
            echo "üöÄ Starting analytics container..."
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              --restart unless-stopped \
              --network liberation-platform-network \
              -p ${{ env.DEPLOY_PORT }}:8080 \
              -e ENVIRONMENT=${{ env.ENVIRONMENT }} \
              -e POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
              -e DATABASE_URL=postgres://liberation:${{ secrets.POSTGRES_PASSWORD }}@liberation-postgres:5432/liberation_analytics \
              -e DUCKDB_PATH=/app/data/analytics.db \
              -e ALLOWED_ORIGINS=https://greenfieldoverride.com,https://staging.greenfieldoverride.com \
              -v /mnt/analytics-volume/data:/app/data \
              liberation-analytics:${{ env.ENVIRONMENT }}-latest
            
            # Wait for analytics to be healthy
            echo "‚è≥ Waiting for analytics to start..."
            sleep 15
            
            # Health check
            echo "üîç Checking analytics health..."
            for i in {1..10}; do
              if curl -f -s http://localhost:${{ env.DEPLOY_PORT }}/api/health; then
                echo "‚úÖ Analytics is healthy!"
                break
              elif [ $i -eq 10 ]; then
                echo "‚ùå Analytics health check failed"
                docker logs ${{ env.CONTAINER_NAME }} --tail 20
                exit 1
              else
                echo "‚è≥ Health check $i/10: waiting..."
                sleep 5
              fi
            done
            
            # Clean up old analytics images
            echo "üßπ Cleaning up old analytics images..."
            docker images liberation-analytics --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}" | \
              grep -v REPOSITORY | \
              grep "${{ env.ENVIRONMENT }}" | \
              sort -k2 -r | \
              tail -n +3 | \
              awk '{print $1}' | \
              xargs -r docker rmi || true
            
            echo "‚úÖ Liberation Analytics deployment complete!"
          EOF

      - name: Verify Analytics Deployment
        run: |
          echo "üîç Verifying analytics deployment..."
          sleep 10
          
           for i in {1..5}; do
             if curl -f -s http://${{ secrets.HETZNER_HOST }}:${{ env.DEPLOY_PORT }}/api/health; then
               echo "‚úÖ Analytics deployment verified!"
               break
             else
               echo "‚è≥ Verification attempt $i/5..."
               if [ $i -eq 5 ]; then
                 echo "‚ùå Analytics verification failed"
                 exit 1
               fi
               sleep 10
             fi
           done

      - name: Analytics Deployment Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "üéâ SUCCESS: Liberation Analytics deployed!"
            echo "üìä Analytics URL: https://analytics.greenfieldoverride.com"
            echo "üîç Health Check: http://${{ secrets.HETZNER_HOST }}:${{ env.DEPLOY_PORT }}/api/health"
            echo "üåç Environment: ${{ env.ENVIRONMENT }}"
            echo "üì¶ Container: ${{ env.CONTAINER_NAME }}"
            echo "üèÉ‚Äç‚ôÇÔ∏è Deployed by: ${{ github.actor }}"
            echo ""
            echo "Next steps:"
            echo "1. Test analytics: curl http://${{ secrets.HETZNER_HOST }}:${{ env.DEPLOY_PORT }}/api/health"
            echo "2. Connect frontend to: https://analytics.greenfieldoverride.com/api"
            echo "3. Monitor logs: ssh and 'docker logs ${{ env.CONTAINER_NAME }}'"
          else
            echo "üí• FAILED: Analytics deployment failed"
            echo "üîç Check logs above for details"
            exit 1
          fi